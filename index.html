<!doctype html>
  <link rel="stylesheet" href="style.css" />

  <body>
    <div id="root"></div>
    <div id="export-image"></div>
    <script src="elm.js"></script>
    <script src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
    <script>
      var isMac = navigator.userAgent.indexOf('Mac OS X') != -1
      var app = Elm.Annotator.embed(document.getElementById("root"), { isMac: isMac });

      app.ports.exportToImage.subscribe(function(image) {
        var canvas = document.createElement('canvas')
        var ctx = canvas.getContext('2d')
        var data = document.getElementById('drawing').outerHTML
        var DOMURL = window.URL || window.webkitURL || window;
        var img = new Image()
        img.onload = function() {
          var drawingImg = new Image()
          var svg = new Blob([data], {type: 'image/svg+xml'});
          var url = DOMURL.createObjectURL(svg);
          drawingImg.onload = function() {
            canvas.width = image.width
            canvas.height = image.height
            ctx.drawImage(img, 0, 0, image.width, image.height)
            ctx.drawImage(drawingImg, 0, 0, image.width, image.height);
            DOMURL.revokeObjectURL(url);
            canvas.toBlob(blob => {
              var exportImage = new Image()
              exportImage.id = 'export-image'
              exportImage.src = DOMURL.createObjectURL(blob)
              document.body.replaceChild(exportImage, document.getElementById('export-image'))
            })
          }
          drawingImg.src = url
        }
        img.src = image.url
      });

      const testEditorHtml = '<div><p>​<img data-imageuploadid="0.601161934050189" src="goat.jpg" data-upload-token="fETc6elwJa6YPIJqhj8lTS4Ir" data-inline-attachment="true" data-upload-id="7000414807" data-original-height="751" data-original-width="639" style="width: 235px; height: 276.189px;">​<br></p><p>goat pics</p><p><img data-imageuploadid="0.641161934050189" src="goat2.jpg" data-upload-token="fETc6elwJaasPIJqhj8lTS4Ir" data-inline-attachment="true" data-upload-id="7020414807" data-original-height="751" data-original-width="639" style="width: 235px; height: 276.189px;">​<br></p></div>';
      const div = document.createElement('div')
      div.innerHTML = testEditorHtml
      const images = div.querySelectorAll('img');

      function toImageObject(image) {
        const width = parseFloat(image.style.width.replace('px', ''));
        const height = parseFloat(image.style.height.replace('px', ''));
        return {
          url: image.src,
          originalWidth: parseFloat(image.getAttribute('data-original-width')),
          originalHeight: parseFloat(image.getAttribute('data-original-height')),
          width: width,
          height: height
        }
      }
      const imageObjects = Array.prototype.map.call(images, toImageObject);
      app.ports.setImages.send(imageObjects)

    </script>
  </body>
